{% extends "base.html" %}

{% block content %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/admin.css') }}">

<div class="container">
    <nav class="breadcrumb admin-breadcrumb" aria-label="breadcrumbs">
        <ul>
            <li><a href="{{ url_for('main.index') }}">Home</a></li>
            <li><a href="{{ url_for('admin.admin_dashboard') }}">Admin</a></li>
            <li class="is-active"><a href="#" aria-current="page">Benutzer</a></li>
        </ul>
    </nav>

    <h1 class="title is-2 has-text-primary">
        <span class="icon-text">
            <span class="icon admin-icon-large admin-icon-primary">
                <i class="fas fa-users"></i>
            </span>
            <span>Benutzer-Verwaltung</span>
        </span>
    </h1>

    <!-- Flash Messages -->
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="notification admin-notification-{{ 'error' if category == 'error' else category }}">
                    <button class="delete" onclick="this.parentElement.style.display='none'"></button>
                    {{ message }}
                </div>
            {% endfor %}
        {% endif %}
    {% endwith %}

    <!-- Benutzer-Tabelle -->
    <div class="box admin-form-container">
        <h2 class="title is-4">Alle Benutzer ({{ users|length }})</h2>
        
        {% if users %}
            <div class="table-container">
                <table class="table admin-table is-fullwidth">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Name</th>
                            <th>Email</th>
                            <th>Aktuelle Rolle</th>
                            <th>Verknüpfter Spieler</th>
                            <th>Aktionen</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for user in users %}
                        <tr>
                            <td>{{ user.id }}</td>
                            <td>
                                <strong>{{ user.name }}</strong>
                                {% if user == current_user %}
                                    <span class="admin-tag-active">Sie</span>
                                {% endif %}
                            </td>
                            <td>{{ user.email or '-' }}</td>
                            <td>
                                {% if user.role == 'admin' %}
                                    <span class="admin-tag-admin">{{ user.role }}</span>
                                {% else %}
                                    <span class="admin-tag-user">{{ user.role }}</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if user.player %}
                                    <a href="{{ url_for('main.show_player', player_name=user.player.name) }}" class="has-text-primary">
                                        {{ user.player.name }}
                                    </a>
                                {% else %}
                                    <span class="has-text-grey">Nicht verknüpft</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if user != current_user %}
                                    <div class="buttons are-small">
                                        {% if user.role == 'user' %}
                                            <form action="{{ url_for('admin.change_user_role', user_id=user.id) }}" method="POST" style="display: inline;">
                                                <input type="hidden" name="role" value="admin">
                                                <button class="button admin-btn-warning is-small" type="submit" onclick="return confirm('Benutzer {{ user.name }} zum Admin machen?')">
                                                    <span class="icon">
                                                        <i class="fas fa-user-shield"></i>
                                                    </span>
                                                    <span>Admin machen</span>
                                                </button>
                                            </form>
                                        {% else %}
                                            <form action="{{ url_for('admin.change_user_role', user_id=user.id) }}" method="POST" style="display: inline;">
                                                <input type="hidden" name="role" value="user">
                                                <button class="button admin-btn-primary is-small" type="submit" onclick="return confirm('Admin-Rechte von {{ user.name }} entfernen?')">
                                                    <span class="icon">
                                                        <i class="fas fa-user"></i>
                                                    </span>
                                                    <span>Zu User machen</span>
                                                </button>
                                            </form>
                                        {% endif %}
                                    </div>
                                {% else %}
                                    <span class="has-text-grey-light">
                                        <span class="icon">
                                            <i class="fas fa-lock"></i>
                                        </span>
                                        Eigenes Konto
                                    </span>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        {% else %}
            <div class="notification admin-notification-info">
                <span class="icon">
                    <i class="fas fa-info-circle"></i>
                </span>
                <strong>Keine Benutzer vorhanden</strong><br>
                Das sollte nicht möglich sein, da Sie als Administrator angemeldet sind.
            </div>
        {% endif %}
    </div>

    <!-- Informationen -->
    <div class="box">
        <h2 class="title is-4">Informationen</h2>
        <div class="content">
            <h3 class="title is-5">Benutzerrollen</h3>
            <div class="columns">
                <div class="column">
                    <div class="notification is-info-light">
                        <h4 class="title is-6">
                            <span class="icon">
                                <i class="fas fa-user"></i>
                            </span>
                            User
                        </h4>
                        <ul>
                            <li>Kann sich anmelden und eigenes Profil verwalten</li>
                            <li>Kann Spieler-Account verknüpfen</li>
                            <li>Kann alle öffentlichen Bereiche einsehen</li>
                        </ul>
                    </div>
                </div>
                <div class="column">
                    <div class="notification is-danger-light">
                        <h4 class="title is-6">
                            <span class="icon">
                                <i class="fas fa-user-shield"></i>
                            </span>
                            Admin
                        </h4>
                        <ul>
                            <li>Alle User-Berechtigungen</li>
                            <li>Zugriff auf Admin-Bereich</li>
                            <li>Kann Events verwalten</li>
                            <li>Kann Datenbank einsehen</li>
                            <li>Kann Benutzerrollen ändern</li>
                        </ul>
                    </div>
                </div>
            </div>
            
            <div class="notification is-warning">
                <p class="has-text-weight-bold">
                    <span class="icon">
                        <i class="fas fa-exclamation-triangle"></i>
                    </span>
                    Wichtiger Hinweis:
                </p>
                <p>Sie können Ihre eigene Rolle nicht ändern. Seien Sie vorsichtig beim Vergeben von Admin-Rechten!</p>
            </div>
        </div>
    </div>
</div>
{% endblock %}
