{% extends 'base.html' %}

{% block content %}

<!-- Spieler Header -->
<section class="section">
  <div class="container">
    <h1 class="title is-1 has-text-centered has-text-primary">
      <span class="icon-text">
        <span class="icon">
          <i class="fas fa-user"></i>
        </span>
        <span>{{ player_name }}</span>
      </span>
    </h1>
    
    <!-- Spieler-Statistiken √úbersicht -->
    {% if player_data.total_games > 0 %}
    <h2 class="title is-3 has-text-centered has-text-primary collapsible-header mt-5" data-target="player-stats-section">
      <span class="icon-text">
        <span class="icon has-text-primary">
          <i class="fas fa-chart-bar"></i>
        </span>
        <span>Spieler-Statistiken</span>
        <span class="icon collapse-icon">
          <i class="fas fa-chevron-up"></i>
        </span>
      </span>
    </h2>
    
    <div id="player-stats-section" class="collapsible-content">
      <div class="box player-stats-overview">
        <div class="columns is-mobile">
          <div class="column has-text-centered">
            <p class="heading">Gespielte Partien</p>
            <p class="title is-3 has-text-white">{{ player_data.total_games }}</p>
          </div>
          <div class="column has-text-centered">
            <p class="heading">Siege</p>
            <p class="title is-3 has-text-white">{{ player_data.wins }}</p>
          </div>
          <div class="column has-text-centered">
            <p class="heading">Siegquote</p>
            <p class="title is-3 has-text-white">{{ player_data.win_rate }}%</p>
          </div>
          <div class="column has-text-centered">
            <p class="heading">√ò Position</p>
            <p class="title is-3 has-text-white">
              {{ player_data.avg_position }}
              <small class="has-text-grey-light">/{{ player_data.avg_player_count }}</small>
            </p>
          </div>
        </div>
      </div>
    </div>
    {% endif %}
  </div>
</section>

<!-- Beste Brettspiele -->
{% if player_data.best_games %}
<section class="section">
  <div class="container">
    <h2 class="title is-2 has-text-centered has-text-primary collapsible-header" data-target="best-games-section">
      <span class="icon-text">
        <span class="icon has-text-primary">
          <i class="fas fa-trophy"></i>
        </span>
        <span>Beste Brettspiele</span>
        <span class="icon collapse-icon">
          <i class="fas fa-chevron-up"></i>
        </span>
      </span>
    </h2>
    <p class="subtitle has-text-centered mb-6 has-text-grey">
      Die Spiele, in denen {{ player_name }} am erfolgreichsten ist und mindestens 2x gespielt wurden
    </p>

    <div id="best-games-section" class="collapsible-content">
      <div class="columns is-multiline">
        {% for game in player_data.best_games %}
        <div class="column is-half-tablet is-one-third-desktop">
          <div class="box best-game-box">
            <div class="media">
              <div class="media-left">
                <div class="best-game-rank">
                  {% if loop.index <= 3 %}
                    {% if loop.index == 1 %}ü•á{% elif loop.index == 2 %}ü•à{% else %}ü•â{% endif %}
                  {% else %}
                    {{ loop.index }}
                  {% endif %}
                </div>
              </div>
              <div class="media-content">
                <p class="title is-5 has-text-primary">{{ game.name }}</p>
                <p class="subtitle is-6 has-text-grey">
                  {{ game.games_played }} Spiel{{ 'e' if game.games_played != 1 else '' }}
                </p>
              </div>
            </div>
            
            <div class="content">
              <div class="columns is-gapless is-multiline">
                <div class="column is-half">
                  <div class="has-text-centered">
                    <p class="heading">Siegquote</p>
                    <p class="title is-6 has-text-success">{{ game.win_rate }}%</p>
                  </div>
                </div>
                <div class="column is-half">
                  <div class="has-text-centered">
                    <p class="heading">√ò Position</p>
                    <p class="title is-6 has-text-info">
                      {{ game.avg_position }}
                      <small class="has-text-grey-light">/{{ game.avg_player_count }}</small>
                    </p>
                  </div>
                </div>
                <div class="column is-half">
                  <div class="has-text-centered">
                    <p class="heading">Siege</p>
                    <p class="title is-6 has-text-warning">{{ game.wins }}</p>
                  </div>
                </div>
                <div class="column is-half">
                  <div class="has-text-centered">
                    <p class="heading">√ò Punkte</p>
                    <p class="title is-6 has-text-primary">{{ game.avg_points }}</p>
                  </div>
                </div>
              </div>
              
              <!-- Performance Indikator -->
              <div class="performance-indicator mt-3">
                <div class="performance-bar-container" 
                     title="Performance basiert auf der durchschnittlichen Platzierung: Je besser die Platzierung im Verh√§ltnis zur Anzahl der Mitspieler, desto h√∂her die Performance. 100% = immer 1. Platz, 0% = immer letzter Platz">
                  <div class="performance-bar" data-width="{{ game.performance }}"></div>
                  <span class="performance-text-overlay">{{ "%.0f"|format(game.performance) }}% Performance</span>
                </div>
              </div>
            </div>
          </div>
        </div>
        {% endfor %}
      </div>
    </div>
  </div>
</section>
{% endif %}

<!-- Spielhistorie -->
{% if player_data.recent_games %}
<section class="section">
  <div class="container">
    <h2 class="title is-2 has-text-centered has-text-primary collapsible-header" data-target="game-history-section">
      <span class="icon-text">
        <span class="icon has-text-primary">
          <i class="fas fa-history"></i>
        </span>
        <span>Spielhistorie</span>
        <span class="icon collapse-icon">
          <i class="fas fa-chevron-up"></i>
        </span>
      </span>
    </h2>
    <p class="subtitle has-text-centered mb-6 has-text-grey-dark">
      Alle gespielten Partien von {{ player_name }} chronologisch sortiert
    </p>

    <!-- Suchfeld f√ºr Spielhistorie -->
    <div class="field mb-5">
      <label class="label">Suche in Spielhistorie</label>
      <div class="control">
        <input id="gameHistorySearch" class="input" type="text" 
               placeholder="Nach Brettspiel, Datum oder Ort suchen...">
      </div>
      <p class="help">Suche nach Brettspiel-Namen, Datum (z.B. "2025", "M√§rz") oder Ort</p>
    </div>

    <div id="game-history-section" class="collapsible-content">
      {% if player_data.games_by_month %}
        {% for month_key in player_data.games_by_month.keys() | sort | reverse %}
          {% set month_games = player_data.games_by_month[month_key] %}
          {% if month_games %}
          <div class="month-section mb-6">
            <h3 class="title is-4 has-text-centered has-text-grey-dark mb-4">
              <span class="icon-text">
                <span class="icon">
                  <i class="fas fa-calendar-alt"></i>
                </span>
                <span>{{ month_games[0].month_display }}</span>
              </span>
            </h3>
            
            <div class="columns is-multiline" id="monthGamesGrid-{{ loop.index }}">
              {% for game in month_games %}
              <div class="column is-half-tablet is-one-third-desktop game-history-item" 
                   data-searchable="{{ game.boardgame_name|lower }} {{ game.date_fmt }} {{ game.location|lower }} {{ month_games[0].month_display|lower }}">
                <div class="box game-history-box {% if game.won %}game-won{% endif %}">
                  <div class="level is-mobile">
                    <div class="level-left">
                      <div class="level-item">
                        <div>
                          <p class="title is-6 has-text-primary">
                            <a href="{{ url_for('main.show_game', game_id=game.game_id) }}" class="has-text-primary game-link">
                              {{ game.boardgame_name }}
                            </a>
                          </p>
                          <p class="subtitle is-7 has-text-grey">{{ game.date_fmt }}</p>
                        </div>
                      </div>
                    </div>
                    <div class="level-right">
                      <div class="level-item">
                        {% if game.won %}
                          <span class="tag is-success">
                            <span class="icon">
                              <i class="fas fa-trophy"></i>
                            </span>
                            <span>Sieg!</span>
                          </span>
                        {% else %}
                          <span class="position-tag position-{{ game.position }}">
                            Platz {{ game.position }}
                          </span>
                        {% endif %}
                      </div>
                    </div>
                  </div>
                  
                  <div class="content">
                    <div class="level is-mobile">
                      <div class="level-item has-text-centered">
                        <div>
                          <p class="heading">Punkte</p>
                          <p class="title is-6">{{ game.points }}</p>
                        </div>
                      </div>
                      <div class="level-item has-text-centered">
                        <div>
                          <p class="heading">Spieler</p>
                          <p class="title is-6">{{ game.total_players }}</p>
                        </div>
                      </div>
                      <div class="level-item has-text-centered">
                        <div>
                          <p class="heading">Ort</p>
                          <p class="title is-7">{{ game.location }}</p>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              {% endfor %}
            </div>
          </div>
          {% endif %}
        {% endfor %}
      {% else %}
        <!-- Fallback falls Monatsgruppierung nicht funktioniert -->
        <div class="columns is-multiline" id="fallbackGamesGrid">
          {% for game in player_data.recent_games %}
          <div class="column is-half-tablet is-one-third-desktop game-history-item" 
               data-searchable="{{ game.boardgame_name|lower }} {{ game.date_fmt }} {{ game.location|lower }}">
            <div class="box game-history-box {% if game.won %}game-won{% endif %}">
              <div class="level is-mobile">
                <div class="level-left">
                  <div class="level-item">
                    <div>
                      <p class="title is-6 has-text-primary">{{ game.boardgame_name }}</p>
                      <p class="subtitle is-7 has-text-grey">{{ game.date_fmt }}</p>
                    </div>
                  </div>
                </div>
                <div class="level-right">
                  <div class="level-item">
                    {% if game.won %}
                      <span class="tag is-success">
                        <span class="icon">
                          <i class="fas fa-trophy"></i>
                        </span>
                        <span>Sieg!</span>
                      </span>
                    {% else %}
                      <span class="position-tag position-{{ game.position }}">
                        Platz {{ game.position }}
                      </span>
                    {% endif %}
                  </div>
                </div>
              </div>
              
              <div class="content">
                <div class="level is-mobile">
                  <div class="level-item has-text-centered">
                    <div>
                      <p class="heading">Punkte</p>
                      <p class="title is-6">{{ game.points }}</p>
                    </div>
                  </div>
                  <div class="level-item has-text-centered">
                    <div>
                      <p class="heading">Spieler</p>
                      <p class="title is-6">{{ game.total_players }}</p>
                    </div>
                  </div>
                  <div class="level-item has-text-centered">
                    <div>
                      <p class="heading">Ort</p>
                      <p class="title is-7">{{ game.location }}</p>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          {% endfor %}
        </div>
      {% endif %}
    </div>
  </div>
</section>
{% endif %}

<!-- Fallback falls keine Daten -->
{% if player_data.total_games == 0 %}
<section class="section">
  <div class="container">
    <div class="notification is-info has-text-centered">
      <span class="icon">
        <i class="fas fa-info-circle"></i>
      </span>
      <strong>Keine Daten gefunden</strong><br>
      F√ºr {{ player_name }} wurden noch keine Spiele in der Datenbank gefunden.
    </div>
  </div>
</section>
{% endif %}

{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialisiere Player Detail Search mit Konfiguration
    initializePlayerDetailSearch({
        searchInputId: 'gameHistorySearch'
    });
});
</script>
{% endblock %}
    margin-bottom: 0.25rem !important; /* Weniger Abstand zwischen √úberschrift und Wert */
    font-size: 0.7rem; /* Kleinere √úberschrift */
}

.best-game-box .title.is-6 {
    margin-bottom: 0.75rem !important; /* Mehr Abstand nach dem Wert */
}

/* Besseres Spacing in der Spielhistorie */
.game-history-box .level .level-item {
    margin-bottom: 0.5rem;
}

.game-history-box .heading {
    margin-bottom: 0.25rem !important; /* Weniger Abstand zwischen √úberschrift und Wert */
    font-size: 0.7rem; /* Kleinere √úberschrift */
}

.game-history-box .title.is-6, 
.game-history-box .title.is-7 {
    margin-bottom: 0.75rem !important; /* Mehr Abstand nach dem Wert */
}

/* Bessere Gruppierung der Statistik-Bereiche */
.has-text-centered > div {
    margin-bottom: 0.75rem; /* Mehr Abstand zwischen Statistik-Gruppen */
}

.has-text-centered:last-child > div {
    margin-bottom: 0; /* Kein Abstand beim letzten Element */
}

/* Mobile Responsive Verbesserungen */
@media screen and (max-width: 768px) {
    
    /* Spieler-Statistiken f√ºr Mobile optimieren */
    .player-stats-overview .columns.is-mobile {
        display: block !important;
    }
    
    .player-stats-overview .column {
        display: flex !important;
        justify-content: space-between !important;
        align-items: center !important;
        padding: 0.75rem 1rem !important;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1) !important;
        text-align: left !important;
    }
    
    .player-stats-overview .column:last-child {
        border-bottom: none !important;
    }
    
    .player-stats-overview .heading {
        font-size: 0.9rem !important;
        margin-bottom: 0 !important;
        font-weight: 600 !important;
    }
    
    .player-stats-overview .title.is-3 {
        font-size: 1.25rem !important;
        margin-bottom: 0 !important;
    }
    
    /* Beste Spiele Boxen f√ºr Mobile */
    .best-game-box {
        padding: 0.75rem !important;
    }
    
    .best-game-box .media-content .title.is-5 {
        font-size: 1rem !important;
        line-height: 1.2 !important;
        word-break: break-word !important;
    }
    
    .best-game-box .columns.is-gapless.is-multiline {
        margin: 0 !important;
    }
    
    .best-game-box .columns.is-gapless .column.is-half {
        width: 50% !important;
        padding: 0.25rem !important;
        text-align: center !important;
    }
    
    .best-game-box .heading {
        font-size: 0.65rem !important;
        margin-bottom: 0.1rem !important;
    }
    
    .best-game-box .title.is-6 {
        font-size: 0.8rem !important;
        margin-bottom: 0.25rem !important;
    }
    
    /* Spielhistorie f√ºr Mobile */
    .game-history-box {
        padding: 0.75rem !important;
        margin-bottom: 0.75rem !important;
    }
    
    .game-history-box .level.is-mobile {
        display: block !important;
        margin-bottom: 0.5rem !important;
    }
    
    .game-history-box .level-left .level-item {
        margin-bottom: 0.25rem !important;
    }
    
    .game-history-box .level-right .level-item {
        margin-bottom: 0.5rem !important;
    }
    
    .game-history-box .title.is-6 {
        font-size: 0.9rem !important;
        line-height: 1.2 !important;
        word-break: break-word !important;
        margin-bottom: 0.1rem !important;
    }
    
    .game-history-box .subtitle.is-7 {
        font-size: 0.75rem !important;
        margin-bottom: 0.25rem !important;
    }
    
    .game-history-box .content .level.is-mobile {
        display: flex !important;
        justify-content: space-around !important;
        text-align: center !important;
    }
    
    .game-history-box .content .level-item {
        flex: 1 !important;
        margin-bottom: 0 !important;
    }
    
    .game-history-box .content .heading {
        font-size: 0.65rem !important;
        margin-bottom: 0.1rem !important;
    }
    
    .game-history-box .content .title.is-6,
    .game-history-box .content .title.is-7 {
        font-size: 0.75rem !important;
        margin-bottom: 0 !important;
        word-break: break-word !important;
    }
    
    /* Monatssektionen */
    .month-section h3.title.is-4 {
        font-size: 1rem !important;
        text-align: left !important;
        margin-bottom: 1rem !important;
    }
    
    /* Position Tags */
    .position-tag {
        font-size: 0.7rem !important;
        padding: 0.2rem 0.4rem !important;
        border-radius: 0.25rem !important;
        white-space: nowrap !important;
    }
    
    /* Tag Verbesserungen */
    .tag.is-success, .tag.is-warning, .tag.is-info, .tag.is-light {
        font-size: 0.7rem !important;
        padding: 0.2rem 0.4rem !important;
        margin: 0.1rem !important;
    }
}

@media screen and (max-width: 480px) {
    
    .player-stats-overview .column {
        padding: 0.5rem 0.75rem !important;
    }
    
    .player-stats-overview .heading {
        font-size: 0.8rem !important;
    }
    
    .player-stats-overview .title.is-3 {
        font-size: 1.1rem !important;
    }
    
    .best-game-box {
        padding: 0.5rem !important;
    }
    
    .game-history-box {
        padding: 0.5rem !important;
    }
    
    .game-history-box .title.is-6 {
        font-size: 0.8rem !important;
    }
    
    .month-section h3.title.is-4 {
        font-size: 0.9rem !important;
    }
}
</style>
