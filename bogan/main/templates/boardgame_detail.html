{% extends 'base.html' %}

{% block content %}

<!-- Oberer Bereich: Brettspiel-Details -->
<section class="section">
  <div class="container">
    <h1 class="title has-text-primary collapsible-header" data-target="boardgame-details">
      <span class="icon-text">
        <span class="icon has-text-primary">
          <i class="fas fa-dice"></i>
        </span>
        <span>{{ boardgame.name }}</span>
        <span class="icon collapse-icon">
          <i class="fas fa-chevron-up"></i>
        </span>
      </span>
    </h1>
    
    <div id="boardgame-details" class="collapsible-content">
      <div class="columns">
        <!-- Spalte für das Bild -->
        <div class="column is-one-quarter">
          <figure class="image">
            <!-- Hier ggf. eigenes Bild angeben -->
            <img src="{{ boardgame.img }}" alt="Spielbox {{ boardgame.name }}" />
          </figure>
        </div>
        <!-- Spalte für die Spiel-Informationen -->
        <div class="column is-one-quarter">
          <p><strong>Spieldauer:</strong> ca. {{ boardgame.playtime }} Minuten</p>
          <p><strong>Komplexität:</strong> {{ boardgame.weight }} / 5</p>
          <p><strong>Spieleranzahl:</strong> {{ boardgame.minplayers }} - {{ boardgame.maxplayers }}</p>
          <p><strong>Erscheinungsjahr:</strong> {{ boardgame.yearpublished }}</p>
          <p><strong>BGG ID</strong> {{ boardgame.bgg_id }}</p>
        </div>
        <!-- Spalte für Siege-Statistiken -->
        {% if win_stats %}
        <div class="column">
          <div class="box win-stats-box">
            <h4 class="title is-6 has-text-centered mb-4">
              <span class="icon-text">
                <span class="icon">
                  <i class="fas fa-crown"></i>
                </span>
                <span>Siege-Statistiken</span>
              </span>
            </h4>
            <p class="has-text-centered has-text-grey mb-3">
              <small>Siege aus {{ games|length }} Spielen</small>
            </p>
            
            <!-- Kompakte Balkendiagramm-Darstellung -->
            <div class="win-chart-compact">
              {% set players_with_wins = win_stats | selectattr('wins', 'gt', 0) | list %}
              {% if players_with_wins %}
                {% for player_win in players_with_wins[:5] %}
                  {% set win_percentage = (player_win.wins / players_with_wins[0].wins * 100) if players_with_wins[0].wins > 0 else 0 %}
                  
                  <div class="win-bar-compact">
                    <!-- Spieler Info -->
                    <div class="win-player-compact">
                      <a href="#detailed-stats-{{ player_win.player_name | replace(' ', '-') }}" class="win-player-name-compact has-text-white">{{ player_win.player_name }}</a>
                      <span class="win-count-compact">{{ player_win.wins }}</span>
                    </div>
                    
                    <!-- Kompakter Balken -->
                    <div class="win-bar-container-compact">
                      <div class="win-bar-compact-fill" 
                           data-wins="{{ player_win.wins }}"
                           data-width="{{ win_percentage }}">
                      </div>
                    </div>
                    
                    <!-- Spielanzahl Info in Klammern -->
                    <div class="win-games-info">
                      ({{ player_win.total_games }})
                    </div>
                  </div>
                {% endfor %}
                
                {% if players_with_wins|length > 5 %}
                  <p class="has-text-grey has-text-centered mt-3">
                    <small>und {{ players_with_wins|length - 5 }} weitere...</small>
                  </p>
                {% endif %}
                
                <!-- Kompakte Zusammenfassung -->
                <div class="columns is-mobile mt-4 pt-3" style="border-top: 1px solid rgba(255,255,255,0.2);">
                  <div class="column has-text-centered">
                    <p class="heading">Spiele</p>
                    <p class="title is-6 has-text-white">{{ games|length }}</p>
                  </div>
                  <div class="column has-text-centered">
                    <p class="heading">Gewinner</p>
                    <p class="title is-6 has-text-white">{{ players_with_wins|length }}</p>
                  </div>
                </div>
              {% else %}
                <div class="has-text-centered has-text-grey">
                  <p><i class="fas fa-info-circle"></i> Noch keine Siege verzeichnet</p>
                </div>
              {% endif %}
            </div>
          </div>
        </div>
        {% endif %}
      </div>
      
      <!-- Allgemeine Spielstatistiken -->
      {% if game_stats and game_stats.total_games > 0 %}
      <div class="box game-stats-box mt-5">
        <h4 class="title is-6 has-text-centered mb-4 has-text-white">
          <span class="icon-text">
            <span class="icon">
              <i class="fas fa-chart-bar"></i>
            </span>
            <span>Allgemeine Spielstatistiken</span>
          </span>
        </h4>
        
        <!-- Gesamtstatistiken -->
        <div class="columns is-mobile">
          <div class="column has-text-centered">
            <p class="heading">Gespielt</p>
            <p class="title is-4 has-text-white">{{ game_stats.total_games }}</p>
          </div>
          <div class="column has-text-centered">
            <p class="heading">Ø Punkte</p>
            <p class="title is-4 has-text-white">{{ game_stats.avg_points }}</p>
          </div>
          <div class="column has-text-centered">
            <p class="heading">Höchste</p>
            <p class="title is-4 has-text-white">{{ game_stats.highest_score }}</p>
          </div>
          <div class="column has-text-centered">
            <p class="heading">Niedrigste</p>
            <p class="title is-4 has-text-white">{{ game_stats.lowest_score }}</p>
          </div>
          <div class="column has-text-centered">
            <p class="heading">Ø Spielzeit</p>
            <p class="title is-4 has-text-white">{% if game_stats.avg_playtime > 0 %}{{ game_stats.avg_playtime }} min{% else %}-{% endif %}</p>
          </div>
        </div>
        
        <!-- Statistiken nach Spieleranzahl -->
        {% if player_count_stats %}
        <hr style="background-color: rgba(255,255,255,0.3); margin: 1.5rem 0;">
        <h5 class="title is-6 has-text-centered mb-3 has-text-white collapsible-header" data-target="player-count-stats">
          <span class="icon-text">
            <span class="icon">
              <i class="fas fa-users"></i>
            </span>
            <span>Nach Spieleranzahl</span>
            <span class="icon collapse-icon">
              <i class="fas fa-chevron-down"></i>
            </span>
          </span>
        </h5>
        
        <div id="player-count-stats" class="collapsible-content" style="display: none;">
          {% for player_count in player_count_stats.keys() | sort %}
            {% set stats = player_count_stats[player_count] %}
            <div class="columns is-mobile">
              <div class="column has-text-centered">
                <p class="heading">{{ player_count }} Spieler</p>
                <p class="title is-6 has-text-grey-light">({{ stats.total_games }} Spiele)</p>
              </div>
              <div class="column has-text-centered">
                <p class="heading">Ø Punkte</p>
                <p class="title is-4 has-text-white">{{ stats.avg_points }}</p>
              </div>
              <div class="column has-text-centered">
                <p class="heading">Höchste</p>
                <p class="title is-4 has-text-white">{{ stats.highest_score }}</p>
              </div>
              <div class="column has-text-centered">
                <p class="heading">Niedrigste</p>
                <p class="title is-4 has-text-white">{{ stats.lowest_score }}</p>
              </div>
              <div class="column has-text-centered">
                <p class="heading">Ø Spielzeit</p>
                <p class="title is-4 has-text-white">{% if stats.avg_playtime > 0 %}{{ stats.avg_playtime }} min{% else %}-{% endif %}</p>
              </div>
            </div>
          {% endfor %}
        </div>
        {% endif %}
      </div>
      {% endif %}
    </div>
  </div>
</section>

<!-- Detaillierte Spieler-Statistiken -->
{% if player_stats %}
<section class="section">
  <div class="container">
    <h2 class="title is-4 collapsible-header" data-target="player-statistics">
      <span class="icon-text">
        <span class="icon">
          <i class="fas fa-chart-line"></i>
        </span>
        <span>Detaillierte Spieler-Statistik</span>
        <span class="icon collapse-icon">
          <i class="fas fa-chevron-up"></i>
        </span>
      </span>
    </h2>
    
    <div id="player-statistics" class="collapsible-content">
      <div class="columns is-multiline">
        {% for player_stat in player_stats %}
          <div class="column is-6-tablet is-4-desktop">
            <div class="box player-stat-box" id="detailed-stats-{{ player_stat.player_name | replace(' ', '-') }}">
              <!-- Spieler Header -->
              <div class="player-stat-header">
                <h4 class="title is-5 has-text-primary">
                  <a href="{{ url_for('main.show_player', player_name=player_stat.player_name) }}" class="has-text-primary player-link">
                    {{ player_stat.player_name }}
                  </a>
                </h4>
                <span class="tag is-info">{{ player_stat.total_games }} Spiele</span>
              </div>
              
              <!-- Statistiken Grid -->
              <div class="player-stat-grid">
                <!-- Durchschnittliche Platzierung -->
                <div class="stat-item">
                  <div class="stat-icon">
                    <i class="fas fa-sort-numeric-down has-text-warning"></i>
                  </div>
                  <div class="stat-content">
                    <p class="stat-label">Ø Platzierung</p>
                    <p class="stat-value">{{ "%.1f"|format(player_stat.avg_position) }}</p>
                    <p class="stat-detail">von {{ "%.1f"|format(player_stat.avg_total_players) }}</p>
                  </div>
                </div>
                
                <!-- Durchschnittliche Punkte -->
                <div class="stat-item">
                  <div class="stat-icon">
                    <i class="fas fa-bullseye has-text-success"></i>
                  </div>
                  <div class="stat-content">
                    <p class="stat-label">Ø Punkte</p>
                    <p class="stat-value">{{ "%.1f"|format(player_stat.avg_points) }}</p>
                  </div>
                </div>
                
                <!-- Min/Max Punkte -->
                <div class="stat-item">
                  <div class="stat-icon">
                    <i class="fas fa-arrows-alt-v has-text-info"></i>
                  </div>
                  <div class="stat-content">
                    <p class="stat-label">Punktespanne</p>
                    <p class="stat-value">{{ player_stat.min_points }} - {{ player_stat.max_points }}</p>
                    <p class="stat-detail">{{ player_stat.max_points - player_stat.min_points }} Spanne</p>
                  </div>
                </div>
                
                <!-- Siege Quote -->
                <div class="stat-item">
                  <div class="stat-icon">
                    <i class="fas fa-trophy has-text-warning"></i>
                  </div>
                  <div class="stat-content">
                    <p class="stat-label">Siege</p>
                    <p class="stat-value">{{ player_stat.wins }}</p>
                    <p class="stat-detail">{{ "%.1f"|format(player_stat.wins / player_stat.total_games * 100) if player_stat.total_games > 0 else 0 }}%</p>
                  </div>
                </div>
              </div>
              
              <!-- Performance Indikator -->
              <div class="performance-indicator mt-4">
                {% set performance = ((player_stat.avg_total_players - player_stat.avg_position) / (player_stat.avg_total_players - 1) * 100) if player_stat.avg_total_players > 1 else 0 %}
                <div class="performance-bar-container" 
                     title="Performance basiert auf der durchschnittlichen Platzierung: Je besser die Platzierung im Verhältnis zur Anzahl der Mitspieler, desto höher die Performance. 100% = immer 1. Platz, 0% = immer letzter Platz">
                  <div class="performance-bar" data-width="{{ performance }}"></div>
                  <span class="performance-text-overlay">{{ "%.0f"|format(performance) }}% Performance</span>
                </div>
              </div>
            </div>
          </div>
        {% endfor %}
      </div>
    </div>
  </div>
</section>
{% endif %}

<!-- Spieler-Ranking -->
{% if ranking_default %}
<section class="section">
  <div class="container">
    <h2 class="title is-3 has-text-primary collapsible-header" data-target="player-ranking">
      <span class="icon-text">
        <span class="icon has-text-primary">
          <i class="fas fa-trophy"></i>
        </span>
        <span>Spieler Ranking</span>
        <span class="icon collapse-icon">
          <i class="fas fa-chevron-up"></i>
        </span>
      </span>
    </h2>
    <p class="subtitle has-text-centered mb-6 has-text-grey-dark">
      Rangliste aller Spieler mit verschiedenen Bewertungsarten
    </p>

    <div id="player-ranking" class="collapsible-content">
      <!-- Standard Tab Navigation (Desktop) -->
      <div class="tabs is-boxed is-large">
        <ul>
          <li class="is-active" data-tab="default">
            <a>
              <span class="icon is-small"><i class="fas fa-trophy"></i></span>
              <span>Standard</span>
            </a>
          </li>
          <li data-tab="playtime">
            <a>
              <span class="icon is-small"><i class="fas fa-clock"></i></span>
              <span>Spielzeit</span>
            </a>
          </li>
          <li data-tab="complexity">
            <a>
              <span class="icon is-small"><i class="fas fa-brain"></i></span>
              <span>Komplexität</span>
            </a>
          </li>
        </ul>
      </div>

      <!-- Custom Mobile Tab System -->
      <div class="mobile-tab-system">
        <button class="mobile-tab-button active" data-tab="default">
          <span class="icon"><i class="fas fa-trophy"></i></span>
          <span>Standard</span>
        </button>
        <button class="mobile-tab-button" data-tab="playtime">
          <span class="icon"><i class="fas fa-clock"></i></span>
          <span>Spielzeit</span>
        </button>
        <button class="mobile-tab-button" data-tab="complexity">
          <span class="icon"><i class="fas fa-brain"></i></span>
          <span>Komplexität</span>
        </button>
      </div>

      <!-- Tab Content -->
      <div class="tabs-content">
        <!-- Default Ranking Tab -->
        <div id="tab-default" class="tab-pane is-active">
          <div class="box">
            <!-- Info Button -->
            {% set md_content = url_for('static', filename='document/ranking_default.md') %}
            <button class="button is-info mb-3" onclick="loadMarkdown('{{ md_content }}', 'markdown-content_default_bg')">
              ℹ️ Info Standard-Ranking
            </button>
            <div id="markdown-content_default_bg" class="notification is-info mt-3 markdown-content"></div>

            <!-- Ranking Table -->
            <div class="table-container event-table-container">
              <table class="table is-bordered is-hoverable is-fullwidth has-text-centered event-table">
                <thead class="has-background-primary-dark has-text-white">
                  <tr>
                    <th class="event-table th">Position</th>
                    <th class="event-table th player-name">Spieler</th>
                    <th class="event-table th points">Gesamtpunkte</th>
                    <th class="event-table th details">Details</th>
                  </tr>
                </thead>
                <tbody>
                  {% for player, data in ranking_default %}
                  <tr>
                    <td><strong>{{ loop.index }}</strong></td>
                    <td><strong>
                      <a href="{{ url_for('main.show_player', player_name=player) }}" class="has-text-primary player-link">
                        {{ player }}
                      </a>
                    </strong></td>
                    <td><strong>{{ data.total|round(2) }}</strong></td>
                    <td>
                      <button class="button is-small is-primary"
                          onclick="toggleElement('details-default-bg{{ loop.index }}')">Details</button>
                      <div id="details-default-bg{{ loop.index }}" class="event-details">
                        <ul class="event-details-list">
                          {% for detail in data.details %}
                          <li>{{ detail.datum }}: <span class="has-text-weight-bold"> {{ detail.game
                                  }}:</span> Pos {{ detail.position }} (Pkte {{ detail.points|round(2) }})
                          </li>
                          {% endfor %}
                        </ul>
                      </div>
                    </td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- Playtime Ranking Tab -->
        <div id="tab-playtime" class="tab-pane">
          <div class="box">
            <!-- Info Button -->
            {% set md_content = url_for('static', filename='document/ranking_playtime.md') %}
            <button class="button is-info mb-3" onclick="loadMarkdown('{{ md_content }}', 'markdown-content_playtime_bg')">
              ℹ️ Info Spielzeit-Ranking
            </button>
            <div id="markdown-content_playtime_bg" class="notification is-info mt-3 markdown-content"></div>

            <!-- Ranking Table -->
            <div class="table-container event-table-container">
              <table class="table is-bordered is-hoverable is-fullwidth has-text-centered event-table">
                <thead class="has-background-primary-dark has-text-white">
                  <tr>
                    <th class="event-table th">Position</th>
                    <th class="event-table th player-name">Spieler</th>
                    <th class="event-table th points">Gesamtpunkte</th>
                    <th class="event-table th details">Details</th>
                  </tr>
                </thead>
                <tbody>
                  {% for player, data in ranking_playtime %}
                  <tr>
                    <td><strong>{{ loop.index }}</strong></td>
                    <td><strong>
                      <a href="{{ url_for('main.show_player', player_name=player) }}" class="has-text-primary player-link">
                        {{ player }}
                      </a>
                    </strong></td>
                    <td><strong>{{ data.total|round(2) }}</strong></td>
                    <td>
                      <button class="button is-small is-primary"
                          onclick="toggleElement('details-playtime-bg{{ loop.index }}')">Details</button>
                      <div id="details-playtime-bg{{ loop.index }}" class="event-details">
                        <ul class="event-details-list">
                          {% for detail in data.details %}
                          <li>{{ detail.datum }}: <span class="has-text-weight-bold"> {{ detail.game
                                  }}:</span> Pos {{ detail.position }} (Pkte {{ detail.points|round(2) }})
                          </li>
                          {% endfor %}
                        </ul>
                      </div>
                    </td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- Complexity Ranking Tab -->
        <div id="tab-complexity" class="tab-pane">
          <div class="box">
            <!-- Info Button -->
            {% set md_content = url_for('static', filename='document/ranking_complexity.md') %}
            <button class="button is-info mb-3" onclick="loadMarkdown('{{ md_content }}', 'markdown-content_complexity_bg')">
              ℹ️ Info Komplexitäts-Ranking
            </button>
            <div id="markdown-content_complexity_bg" class="notification is-info mt-3 markdown-content"></div>

            <!-- Ranking Table -->
            <div class="table-container event-table-container">
              <table class="table is-bordered is-hoverable is-fullwidth has-text-centered event-table">
                <thead class="has-background-primary-dark has-text-white">
                  <tr>
                    <th class="event-table th">Position</th>
                    <th class="event-table th player-name">Spieler</th>
                    <th class="event-table th points">Gesamtpunkte</th>
                    <th class="event-table th details">Details</th>
                  </tr>
                </thead>
                <tbody>
                  {% for player, data in ranking_complexity %}
                  <tr>
                    <td><strong>{{ loop.index }}</strong></td>
                    <td><strong>
                      <a href="{{ url_for('main.show_player', player_name=player) }}" class="has-text-primary player-link">
                        {{ player }}
                      </a>
                    </strong></td>
                    <td><strong>{{ data.total|round(2) }}</strong></td>
                    <td>
                      <button class="button is-small is-primary"
                          onclick="toggleElement('details-complexity-bg{{ loop.index }}')">Details</button>
                      <div id="details-complexity-bg{{ loop.index }}" class="event-details">
                        <ul class="event-details-list">
                          {% for detail in data.details %}
                          <li>{{ detail.datum }}: <span class="has-text-weight-bold"> {{ detail.game
                                  }}:</span> Pos {{ detail.position }} (Pkte {{ detail.points|round(2) }})
                          </li>
                          {% endfor %}
                        </ul>
                      </div>
                    </td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>
{% endif %}

<!-- Gespielte Partien -->
<section class="section">
  <div class="container">
    <h2 class="title is-3 has-text-primary collapsible-header" data-target="game-history">
      <span class="icon-text">
        <span class="icon has-text-primary">
          <i class="fas fa-history"></i>
        </span>
        <span>Gespielte Partien</span>
        <span class="icon collapse-icon">
          <i class="fas fa-chevron-up"></i>
        </span>
      </span>
    </h2>
    
    <div id="game-history" class="collapsible-content">
      <div class="columns is-multiline">
        <!-- Alle gespielte Partien -->
        {% for game in games %}
        <div class="column is-half">
          <article class="box">
            <h3 class="title is-5">
              <a href="{{ url_for('main.show_game', game_id=game.id) }}" class="has-text-primary game-link">
                Partie vom {{ game.datum.strftime('%d.%b %Y') }}
              </a>
            </h3>
            <!-- Sieger -->
            <p class="has-text-info-50"><strong class="has-text-info-60">Sieger:</strong> 
              <a href="{{ url_for('main.show_player', player_name=game.player_pos[0].player.name) }}" class="has-text-primary player-link">
                {{ game.player_pos[0].player.name }}
              </a>
            </p>
            <p> <br> </p>
            <p><strong>Spieler (Punkte):</strong>
              {% for player in game.player_pos %}
            <p> Pos {{ loop.index}}: 
              <strong>
                <a href="{{ url_for('main.show_player', player_name=player.player.name) }}" class="has-text-primary player-link">
                  {{ player.player.name }}
                </a>
              </strong> ({{ player.points }} Punkte) 
            </p>
            {% endfor %}
            <p> <br> </p>
            <p><strong>Spielzeit[min]</strong> {{ '-' if game.playtime < 15 else game.playtime }}</p>
            <p><strong>Ort</strong> {{ game.location.name }}</p>

          </article>
        </div>
        {% endfor %}
      </div>
    </div>
  </div>
</section>


{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialisiere Tabs
    initializeTabs();
    
    // Mobile Tab-Styles durchsetzen
    function enforceMobileTabStyles() {
        const isMobile = window.innerWidth <= 768;
        const tabs = document.querySelectorAll('#boardgame-tabs .tabs li a');
        
        tabs.forEach(function(tab) {
            const isActive = tab.parentElement.classList.contains('is-active');
            
            if (isMobile) {
                // Mobile Styles forcieren
                if (isActive) {
                    tab.style.cssText = `
                        color: #ffffff !important;
                        background-color: #3273dc !important;
                        border: 3px solid #3273dc !important;
                        font-weight: 900 !important;
                        font-size: 1.1rem !important;
                        min-height: 50px !important;
                        display: flex !important;
                        align-items: center !important;
                        justify-content: center !important;
                        padding: 1rem 0.75rem !important;
                        border-radius: 8px !important;
                        box-shadow: 0 6px 12px rgba(50, 115, 220, 0.4) !important;
                        text-shadow: 2px 2px 4px rgba(0,0,0,0.5) !important;
                    `;
                } else {
                    tab.style.cssText = `
                        color: #000000 !important;
                        background-color: #ffffff !important;
                        border: 3px solid #3273dc !important;
                        font-weight: 900 !important;
                        font-size: 1.1rem !important;
                        min-height: 50px !important;
                        display: flex !important;
                        align-items: center !important;
                        justify-content: center !important;
                        padding: 1rem 0.75rem !important;
                        border-radius: 8px !important;
                        box-shadow: 0 3px 6px rgba(0,0,0,0.15) !important;
                    `;
                }
            }
        });
    }
    
    // Initial enforcement
    enforceMobileTabStyles();
    
    // Re-enforce on resize
    window.addEventListener('resize', enforceMobileTabStyles);
    
    // Re-enforce on tab changes
    const tabElements = document.querySelectorAll('#boardgame-tabs .tabs li');
    tabElements.forEach(function(tabEl) {
        tabEl.addEventListener('click', function() {
            setTimeout(enforceMobileTabStyles, 100);
        });
    });
});
</script>
{% endblock %}